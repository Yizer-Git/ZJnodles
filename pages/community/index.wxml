<view class="ds-page community-page">
  <view class="profile-card ds-card ds-card--accent">
    <view class="profile-info">
      <image class="avatar" mode="aspectFill" src="{{profile && profile.avatar ? profile.avatar : '/assets/avatar-placeholder.jpg'}}"></image>
      <view class="profile-meta">
        <text class="nickname">{{profile && profile.nickname ? profile.nickname : 'æ¸¸å®¢'}}</text>
        <text class="level">LV{{profile && profile.level ? profile.level : 0}} {{profile && profile.levelName ? profile.levelName : 'ä½“éªŒä¼šå‘˜'}}</text>
      </view>
    </view>
    <view class="profile-stats">
      <view class="stat">
        <text class="stat-number">{{profile && profile.points ? profile.points : 2680}}</text>
        <text class="stat-label">ç§¯åˆ†</text>
      </view>
      <view class="stat">
        <text class="stat-number">{{profile && profile.growthValue ? profile.growthValue : 540}}</text>
        <text class="stat-label">æˆé•¿å€¼</text>
      </view>
      <view class="stat">
        <text class="stat-number">{{profile && profile.couponCount ? profile.couponCount : 4}}</text>
        <text class="stat-label">ä¼˜æƒ åˆ¸</text>
      </view>
    </view>
    <button class="checkin-btn pill-btn pill-btn--ghost" bindtap="handleCheckIn">ç­¾åˆ°é¢†ç§¯åˆ†</button>
  </view>

  <view class="ds-section">
    <view class="ds-section__header">
      <text class="ds-title">ä»»åŠ¡ä¸­å¿ƒ</text>
      <text class="ds-subtitle">å®Œæˆä»»åŠ¡æå‡ç­‰çº§æƒç›Š</text>
    </view>
    <view wx:if="{{loading}}" class="task-skeleton">
      <block wx:for="{{[1,2,3]}}" wx:key="*this">
        <view class="task-card ds-card ds-shimmer"></view>
      </block>
    </view>
    <block wx:else>
      <block wx:for="{{tasks}}" wx:key="id">
        <view class="task-card ds-card" bindtap="viewTask" data-id="{{item.id}}">
          <view class="task-info">
            <text class="task-title">{{item.name}}</text>
            <text class="task-desc">{{item.description}}</text>
          </view>
          <view class="task-meta">
            <text class="task-points">+{{item.rewardPoints}}ç§¯åˆ†</text>
            <text class="task-status">{{item.statusLabel}}</text>
          </view>
        </view>
      </block>
    </block>
  </view>

  <view class="ds-section">
    <view class="ds-section__header">
      <text class="ds-title">ç¤¾åŒºåŠ¨æ€</text>
      <text class="ds-subtitle">ä¼šå‘˜ç²¾é€‰Â·UGCå†…å®¹</text>
    </view>
    <view class="sub-tabs" wx:if="{{feedTabs.length > 1}}">
      <block wx:for="{{feedTabs}}" wx:key="*this">
        <view
          class="sub-tab-item {{activeFeedTab === item ? 'active' : ''}}"
          data-tab="{{item}}"
          bindtap="handleFeedTabChange"
        >
          {{item}}
        </view>
      </block>
    </view>
    <block wx:if="{{displayFeeds.length === 0}}">
      <view class="empty ds-card ds-card--frosted">æš‚æ— åŠ¨æ€ï¼Œæ¬¢è¿å‘å¸ƒä½ çš„æ•…äº‹</view>
    </block>
    <block wx:else>
      <block wx:for="{{displayFeeds}}" wx:key="id">
        <view class="feed-card-large ds-card surface-card">
          <image
            class="feed-cover-lg"
            mode="aspectFill"
            src="{{item.cover ? item.cover : (item.images && item.images.length ? item.images[0] : '/assets/images/promo-images/0.png')}}"
          ></image>
          <view class="feed-meta-content">
            <view class="feed-meta-top">
              <view class="feed-tag feed-tag-new" wx:if="{{item.tag || item.category}}">
                {{item.tag ? item.tag : item.category}}
              </view>
              <text class="feed-time">{{item.publishTimeText ? item.publishTimeText : 'åˆšåˆšæ›´æ–°'}}</text>
            </view>
            <text class="feed-title-lg">{{item.title ? item.title : (item.content ? item.content : 'ç¤¾åŒºåŠ¨æ€')}}</text>
            <text
              class="feed-subtitle-lg"
              wx:if="{{item.summary || item.excerpt || item.content}}"
            >
              {{item.summary ? item.summary : (item.excerpt ? item.excerpt : (item.content ? item.content : ''))}}
            </text>
            <view class="feed-actions-lg">
              <view class="feed-author-meta">
                <image
                  class="feed-avatar-sm"
                  mode="aspectFill"
                  src="{{item.authorAvatar ? item.authorAvatar : '/assets/avatar-placeholder.jpg'}}"
                ></image>
                <view class="feed-author-text">
                  <text class="feed-author">{{item.authorName ? item.authorName : 'ç¤¾åŒºæˆå‘˜'}}</text>
                  <text class="feed-author-role">
                    {{item.authorRole ? item.authorRole : 'å…±åˆ›è€…'}}
                  </text>
                </view>
              </view>
              <view class="feed-stats">
                <view class="feed-stat-item">
                  <text class="feed-stat-icon">ğŸ‘</text>
                  <text class="feed-stat-value">{{item.views ? item.views : (item.reads ? item.reads : 0)}}</text>
                </view>
                <view class="feed-stat-item">
                  <text class="feed-stat-icon">ğŸ‘</text>
                  <text class="feed-stat-value">{{item.likes ? item.likes : 0}}</text>
                </view>
                <view class="feed-stat-item">
                  <text class="feed-stat-icon">ğŸ’¬</text>
                  <text class="feed-stat-value">{{item.comments ? item.comments : 0}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
    </block>
  </view>

  <view class="ds-section">
    <view class="ds-section__header">
      <text class="ds-title">ç§¯åˆ†å•†åŸ</text>
      <text class="ds-subtitle">å…‘æ¢å‘¨è¾¹ä¸ä½“éªŒ</text>
    </view>
    <scroll-view scroll-x class="mall-scroll">
      <block wx:for="{{mall}}" wx:key="id">
        <view class="mall-item ds-card">
          <image class="mall-cover" mode="aspectFill" src="{{item.cover}}"></image>
          <text class="mall-title">{{item.title}}</text>
          <text class="mall-points">{{item.points}}ç§¯åˆ†</text>
          <button class="pill-btn pill-btn--primary" size="mini" bindtap="redeemReward" data-id="{{item.id}}">ç«‹å³å…‘æ¢</button>
        </view>
      </block>
    </scroll-view>
  </view>

  <view wx:if="{{showTaskSheet}}" class="task-sheet">
    <view class="sheet-mask" bindtap="closeTaskSheet"></view>
    <view class="sheet-content ds-card ds-card--frosted">
      <text class="sheet-title">{{activeTask && activeTask.name ? activeTask.name : ''}}</text>
      <text class="sheet-desc">{{activeTask && activeTask.description ? activeTask.description : ''}}</text>
      <view class="sheet-meta">
        <text>å¥–åŠ±ï¼š{{activeTask && activeTask.rewardPoints ? activeTask.rewardPoints : 0}}ç§¯åˆ†</text>
        <text>æˆªæ­¢ï¼š{{activeTask && activeTask.deadlineText ? activeTask.deadlineText : ''}}</text>
      </view>
      <button class="sheet-confirm pill-btn pill-btn--primary" bindtap="acceptTask">ç«‹å³å‚ä¸</button>
    </view>
  </view>
</view>


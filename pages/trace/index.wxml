<view class="page">
  <view class="header surface-card surface-card--frosted">
    <text class="title">区块链溯源中心</text>
    <text class="subtitle">批次上链 · 质检报告 · 异常闭环</text>
  </view>

  <view class="search-bar surface-card surface-card--frosted">
    <input class="search-input" placeholder="输入批次码 / 一物一码" bindinput="onInput" value="{{code}}" />
    <button class="pill-btn pill-btn--ghost" size="mini" bindtap="handleScan">扫码</button>
    <button class="pill-btn pill-btn--primary" size="mini" type="primary" bindtap="search">查询</button>
  </view>

  <view wx:if="{{loading}}" class="state surface-card surface-card--frosted shimmer skeleton">查询中...</view>

  <view wx:if="{{batch}}" class="result-card surface-card">
    <view class="result-row">
      <text class="label">批次号</text>
      <text class="value">{{batch.batchCode}}</text>
    </view>
    <view class="result-row">
      <text class="label">上链时间</text>
      <text class="value">{{batch.chainTimestamp}}</text>
    </view>
    <view class="result-row">
      <text class="label">当前状态</text>
      <text class="status">{{batch.statusLabel || batch.status}}</text>
    </view>

    <view class="section">
      <view class="section-header">
        <text class="section-title">质检报告</text>
      </view>
      <block wx:if="{{!batch.reports || !batch.reports.length}}">
        <text class="empty surface-card surface-card--frosted">暂无质检数据</text>
      </block>
      <block wx:else>
        <block wx:for="{{batch.reports}}" wx:key="id">
          <view class="report-item surface-card surface-card--frosted">
            <text class="report-title">{{item.title}}</text>
            <text class="report-result">{{item.result}}</text>
            <text class="report-time">{{item.timestamp}}</text>
          </view>
        </block>
      </block>
    </view>

    <view class="section">
      <view class="section-header">
        <text class="section-title">区块链记录</text>
      </view>
      <block wx:if="{{!batch.chainRecords || !batch.chainRecords.length}}">
        <text class="empty surface-card surface-card--frosted">暂无上链记录</text>
      </block>
      <block wx:else>
        <block wx:for="{{batch.chainRecords}}" wx:key="hash">
          <view class="chain-item surface-card surface-card--frosted">
            <text class="hash">{{item.hash}}</text>
            <text class="node">节点：{{item.node}}</text>
            <text class="time">{{item.timestamp}}</text>
          </view>
        </block>
      </block>
    </view>

    <button class="feedback-btn pill-btn pill-btn--primary" bindtap="openFeedback">发现异常，提交质检反馈</button>
  </view>

  <block wx:if="{{!loading && !batch}}">
    <view class="placeholder">
      <text>输入批次码或扫一扫包装码，查看完整溯源链路。</text>
    </view>

    <view class="sample-section">
      <text class="sample-title">示例批次 · 实景数据</text>
      <text class="sample-desc">以下为中江挂面链上真实案例，帮助你了解可追溯信息的呈现方式。</text>

      <block wx:for="{{sampleBatches}}" wx:key="batchCode">
        <view class="sample-card surface-card surface-card--frosted">
          <view class="sample-card__header">
            <view class="sample-card__meta">
              <text class="sample-batch">{{item.batchCode}}</text>
              <text class="sample-product">{{item.productName}}</text>
            </view>
            <text class="sample-status">{{item.statusLabel}}</text>
          </view>

          <view class="sample-info">
            <text>产地：{{item.origin}}</text>
            <text>收割：{{item.harvestDate}}</text>
            <text>上链：{{item.chainTimestamp}}</text>
          </view>

          <text class="sample-summary">{{item.qualitySummary}}</text>

          <view class="sample-tags">
            <block wx:for="{{item.highlights}}" wx:key="*this">
              <text class="sample-tag">{{item}}</text>
            </block>
          </view>

          <view class="sample-timeline">
            <text class="timeline-title">链路节点</text>
            <block wx:for="{{item.chainRecords}}" wx:key="time">
              <view class="timeline-item">
                <text class="timeline-step">{{item.step}}</text>
                <text class="timeline-detail">{{item.detail}}</text>
                <text class="timeline-meta">{{item.time}} · {{item.operator}}</text>
              </view>
            </block>
          </view>
        </view>
      </block>
    </view>
  </block>

  <view wx:if="{{showFeedback}}" class="feedback-dialog">
    <view class="dialog-content surface-card surface-card--frosted">
      <text class="dialog-title">异常反馈闭环</text>
      <textarea class="dialog-input" placeholder="请描述发现的问题，例如口感、包装破损、配送异常..." bindinput="handleFeedbackInput" data-field="message" value="{{feedback.message}}"></textarea>
      <input class="dialog-input" placeholder="手机号 / 邮箱（选填，方便回访）" bindinput="handleFeedbackInput" data-field="contact" value="{{feedback.contact}}" />
      <view class="dialog-actions">
        <button class="pill-btn pill-btn--ghost" size="mini" bindtap="closeFeedback">取消</button>
        <button class="pill-btn pill-btn--primary" size="mini" type="primary" bindtap="submitFeedback">提交</button>
      </view>
    </view>
  </view>
</view>
